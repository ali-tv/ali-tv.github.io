#!/usr/bin/env python3
"""
m3u_rewriter.py

- Kaynak M3U URL'sini indirir
- TÃ¼m #EXTINF satÄ±rlarÄ±na group-title="FilmlerğŸ­" ekler/overridelar
- TÃ¼m #EXTINF satÄ±rlarÄ±na copyright="@ali_hsyn3" ekler/overridelar
- Ã‡Ä±ktÄ±yÄ± belirtilen dosyaya yazar

KullanÄ±m:
  python3 m3u_rewriter.py --source "https://raw.githubusercontent.com/GitLatte/patr0n/refs/heads/site/lists/power-sinema.m3u" --output ./AliTv.m3u
"""

import argparse
import re
import sys
from urllib.parse import urlparse

try:
    import requests
except ImportError:
    print("requests kÃ¼tÃ¼phanesi gerekli. Kurmak iÃ§in: pip install requests")
    sys.exit(1)


EXTINF_RE = re.compile(r'^(#EXTINF:[^\n]*)(\n?)', flags=re.IGNORECASE)
# regex to capture attributes part (between EXTINF:... and comma-title)
ATTRS_RE = re.compile(r'(#EXTINF:-?\d+\s*)([^,]*)(,)(.*)', flags=re.IGNORECASE)

def rewrite_extinf_line(line, group_title='FilmlerğŸ­', copyright_tag='@ali_hsyn3'):
    """
    line Ã¶rn: #EXTINF:-1 tvg-id="..." tvg-name="..." group-title="Eski",Film AdÄ±
    Amac: attribute kÄ±smÄ±nÄ± dÃ¼zenle / ekle, son olarak ",BaÅŸlÄ±k" kÄ±smÄ±nÄ± koru
    """
    m = ATTRS_RE.match(line)
    if not m:
        # eÄŸer beklenen formatta deÄŸilse, en basit ÅŸekilde group-title & copyright ekle
        if line.strip().startswith('#EXTINF'):
            # eklemeden Ã¶nce virgÃ¼l varsa baÅŸlÄ±k kÄ±smÄ±nÄ± koru
            if ',' in line:
                left, right = line.split(',', 1)
                left = left.strip()
                left = left + f' group-title="{group_title}" copyright="{copyright_tag}"'
                return left + ',' + right
            else:
                return line.strip() + f' group-title="{group_title}" copyright="{copyright_tag}"\n'
        return line

    prefix = m.group(1)   # '#EXTINF:-1 '
    attrs = m.group(2)    # 'tvg-id=".." tvg-name=".." group-title="Eski"'
    comma = m.group(3)    # ','
    title = m.group(4)    # 'Film AdÄ±'

    # remove existing group-title= and copyright= if present
    attrs = re.sub(r'\bgroup-title="[^"]*"', '', attrs, flags=re.IGNORECASE)
    attrs = re.sub(r'\bcopyright="[^"]*"', '', attrs, flags=re.IGNORECASE)

    # normalize whitespace
    attrs = ' '.join(attrs.split()).strip()
    if attrs:
        attrs = attrs + ' '
    # append forced attributes
    attrs = attrs + f'group-title="{group_title}" copyright="{copyright_tag}"'

    return f'{prefix}{attrs}{comma}{title}'

def process_m3u_text(text, group_title, copyright_tag):
    # ensure header
    lines = text.splitlines(True)  # preserve newline chars
    out_lines = []
    header_seen = False
    for line in lines:
        if not header_seen and line.strip().upper().startswith('#EXTM3U'):
            header_seen = True
            out_lines.append(line)
            continue
        if line.strip().upper().startswith('#EXTINF'):
            new_line = rewrite_extinf_line(line, group_title, copyright_tag)
            out_lines.append(new_line if new_line.endswith('\n') else new_line + '\n')
        else:
            out_lines.append(line)
    if not header_seen:
        # add header
        out_lines.insert(0, '#EXTM3U\n')
    return ''.join(out_lines)


def fetch_source(url, timeout=15, user_agent=None):
    headers = {}
    if user_agent:
        headers['User-Agent'] = user_agent
    else:
        headers['User-Agent'] = 'm3u-rewriter/1.0 (+https://example)'
    resp = requests.get(url, headers=headers, timeout=timeout)
    resp.raise_for_status()
    # assume utf-8 but fallback
    encoding = resp.encoding if resp.encoding else 'utf-8'
    return resp.content.decode(encoding, errors='replace')


def main():
    p = argparse.ArgumentParser(description="M3U downloader + rewriter")
    p.add_argument('--source', '-s', required=True, help='Uzaktaki m3u URL')
    p.add_argument('--output', '-o', required=True, help='Ã‡Ä±kÄ±ÅŸ dosyasÄ± (Ã¶r. ali_filmler.m3u)')
    p.add_argument('--group', '-g', default='FilmlerğŸ­', help='group-title deÄŸeri (default: FilmlerğŸ­)')
    p.add_argument('--copyright', '-c', default='@ali_hsyn3', help='copyright deÄŸeri (default: @ali_hsyn3)')
    p.add_argument('--timeout', type=int, default=15, help='Ä°stek zaman aÅŸÄ±mÄ± saniye (default 15)')
    p.add_argument('--user-agent', default=None, help='Ã–zel User-Agent header')
    args = p.parse_args()

    try:
        print(f"Kaynaktan indiriliyor: {args.source}")
        txt = fetch_source(args.source, timeout=args.timeout, user_agent=args.user_agent)
    except Exception as e:
        print("Kaynak indirilemedi:", e)
        sys.exit(2)

    out = process_m3u_text(txt, args.group, args.copyright)

    try:
        with open(args.output, 'w', encoding='utf-8') as f:
            f.write(out)
        print("YazÄ±ldÄ±:", args.output)
    except Exception as e:
        print("Yazma hatasÄ±:", e)
        sys.exit(3)


if __name__ == '__main__':
    main()
